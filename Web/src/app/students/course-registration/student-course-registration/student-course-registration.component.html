<nz-tabset class="custom-tabset">
  <nz-tab [nzTitle]="seasonTitles" class="custom-tab" *ngIf="resultStatus != 2 && resultStatus != 5">
    <ng-template #titleoffering>
      <span nz-icon nzType="desktop"></span>
      {{ nextTerm }}
    </ng-template>
    <div *ngIf="havePreparedCourseOffering && studentTermCourseReg.isAllowedToRegister==1;else elseBlock">
      <div class="academic-header" *ngIf="studentTermCourseReg">
        <div class="academic-info">
          <div class="info-item">
            <span class="label">Student Name:</span>
            <span class="value">{{studentTermCourseReg?.fullName}}</span>
          </div>
          <div class="info-item">
            <span class="label">Student ID:</span>
            <span class="value">{{studentTermCourseReg?.studentId}}</span>
          </div>
          <div class="info-item">
            <span class="label">Batch Code:</span>
            <span class="value">{{studentTermCourseReg.batchCode}}</span>
          </div>

        </div>
      </div>

      <div class="credit-hours-summary" style="margin: 20px 0; padding: 15px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #e8e8e8;">
        <div style="display: flex; flex-wrap: wrap; gap: 16px; justify-content: space-between; align-items: center;">
          <div style="font-size: 16px; flex: 1; min-width: 250px;">
            <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 8px;">
              <span style="font-weight: bold;">Total Selected Credit Hours:</span>
              <span [style.color]="totalSelectedCreditHours > getMaxAllowedCreditHours() ? '#ff4d4f' : '#52c41a'" 
                    style="font-size: 20px; display: inline-block;">
                {{ totalSelectedCreditHours }}
              </span>
            </div>
          </div>
          <div style="font-size: 16px; flex: 1; min-width: 250px;">
            <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 8px;">
              <span style="font-weight: bold;">Maximum Allowed Credit Hours:</span>
              <span style="font-size: 20px; color: #1890ff; display: inline-block;">
                {{ getMaxAllowedCreditHours() }}
              </span>
            </div>
          </div>
          <div style="font-size: 16px; flex: 1; min-width: 250px;">
            <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 8px;">
              <span style="font-weight: bold;">CGPA:</span>
              <span [style.color]="studentTermCourseReg?.cgpa >= 1.5 ? '#52c41a' : '#ff4d4f'" 
                    style="font-size: 20px; display: inline-block;">
                {{ studentTermCourseReg?.cgpa | number:'1.2-2' }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <nz-card nzType="inner" [nzTitle]="courseSectionTitle" class="card-section">
        <nz-alert nzType="info" nzShowIcon [nzMessage]="'Regular Term Registration'"
          [nzDescription]="'Select the courses you want to register for the current term. These are your primary course selections.'"
          style="margin-bottom: 16px;"></nz-alert>
        <div id="print-section" class="print-section">
          <button class="print-button" (click)="printSlip()">
            <span nz-icon nzType="printer" nzTheme="outline"></span>
            Show Slip
          </button>
          <button class="print-button" (click)="downloadPDF()">
            <span nz-icon nzType="download" nzTheme="outline"></span>
            Download PDF
          </button>
        </div>

        <nz-spin [nzSpinning]="isLoadingRegularCourses">
          <div class="responsive-table-wrapper">
            <nz-table #basicTable [nzData]="studentTermCourseReg?.courseTermOfferings" nzShowSizeChanger
              (nzCurrentPageDataChange)="onCurrentPageDataChange($event)" nzBordered [nzShowPagination]="false">
              <thead class="table-header-row">
                <tr class="table-header-row">
                  <th class="paginate" [nzChecked]="checkedRegularCourses"
                    [nzIndeterminate]="indeterminateRegularCourses" (nzCheckedChange)="onAllChecked($event, 'regular')">
                  </th>
                  <th class="th-row">Course Code</th>
                  <th class="th-row">Course Title</th>
                  <th class="th-row">Status</th>
                  <th class="th-row">Grade</th>
                  <th class="th-row">Credit Hour</th>
                  <th class="th-row">Total Amount</th>
                </tr>
              </thead>
              <tbody>
                <ng-container tabindex="0" *ngFor="let data of basicTable.data; let i = index">
                  <tr [class.disabled-row]="!setOfCheckedId.has(data.courseId)"
                    [style.background-color]="isRegularCourseDisabled(data) ? '#fff1f0' : '#ffffff'"
                    [style.color]="isRegularCourseDisabled(data) ? '#595959' : ''">
                    <td class="paginate">
                      <ng-container *ngIf="isRegularCourseDisabled(data); else regularCheckbox">
                        <span nz-icon nzType="lock" nzTheme="outline" style="color: #ff4d4f; font-size: 20px;"
                          nz-tooltip [nzTooltipTitle]="data.currentGrade === 'RA' ? 'Course is not available for regular registration' : 
                            (data.courseStatus === 'Taken' && (['A+', 'A', 'B', 'B+', 'C', 'D', ''].includes(data.currentGrade))) ? 
                            'Course has already been taken ' : 
                            'Course is not available for selection'" nzTooltipPlacement="right"
                          [nzTooltipColor]="'#1890ff'">
                        </span>
                      </ng-container>
                      <ng-template #regularCheckbox>
                        <label nz-checkbox [nzChecked]="setOfCheckedId.has(data.courseId)"
                          (nzCheckedChange)="onItemChecked(data.courseId, $event, false)"
                          [nzDisabled]="isRegularCourseDisabled(data) || isCourseSelectedInOtherTable(data, 'available')">
                        </label>
                      </ng-template>
                    </td>
                    <td>{{data.courseCode}}</td>
                    <td>{{ data.courseTitle }} </td>
                    <td>{{ data.courseStatus }}</td>
                    <td>{{ data.currentGrade }}</td>
                    <td style="text-align: center;">{{ data.creditHours }}</td>
                    <td style="text-align: center;">{{ data.totalAmount }}</td>
                  </tr>
                </ng-container>
              </tbody>
              <tfoot class="footer-row">
                <tr>
                  <td colspan="5" style="font-weight: bold;">Total</td>
                  <td style="font-weight: bold;">{{ getTotalCreditHours() }}</td>
                  <td style="font-weight: bold;">{{ getTotalAmount() | number:'1.2-2' }}</td>
                </tr>
              </tfoot>
            </nz-table>
          </div>
        </nz-spin>
      </nz-card>
      <nz-card nzType="inner" [nzTitle]="courseAddTitle" class="card-section">
        <nz-alert nzType="warning" nzShowIcon [nzMessage]="'Add Course Request'"
          [nzDescription]="'You can select up to 3 additional courses. Each course must be assigned a priority (1-3) before selecting another course. Priority 1 is the highest priority.'"
          style="margin-bottom: 16px;"></nz-alert>
        <div style="margin-bottom: 16px;">
          <nz-input-group nzSearch [nzAddOnAfter]="searchButton">
            <input type="text" nz-input placeholder="Search by course code or title" [(ngModel)]="searchAddCourseText"
              (ngModelChange)="filterAddCourses()" />
          </nz-input-group>
          <ng-template #searchButton>
            <button nz-button nzType="primary" nzSearch (click)="filterAddCourses()">
              <span nz-icon nzType="search"></span>
            </button>
          </ng-template>
        </div>
        <nz-spin [nzSpinning]="isLoadingAddCourses">
          <div class="responsive-table-wrapper">
            <nz-table #addTable [nzData]="filteredAddCourses" nzShowSizeChanger
              (nzCurrentPageDataChange)="onCurrentPageDataChange($event)" nzBordered [nzShowPagination]="false"
              [nzScroll]="{ y: tableScrollHeight }" [nzPageSize]="filteredAddCourses.length">
              <thead class="table-header-row">
                <tr class="table-header-row">
                  <th class="paginate" [nzChecked]="checkedAddCourses" [nzIndeterminate]="indeterminateAddCourses"
                    (nzCheckedChange)="onAllChecked($event, 'add')" [nzDisabled]="true">
                  </th>
                  <!-- <th class="th-row">Batch Code</th> -->
                  <th class="th-row">Course Code</th>
                  <th class="th-row">Course Title</th>
                  <th class="th-row">Status</th>
                  <th class="th-row">Grade</th>
                  <th class="th-row">Credit Hour</th>
                  <th class="th-row">Total Amount</th>
                  <th class="th-row">Priority</th>
                </tr>
              </thead>
              <tbody>
                <ng-container tabindex="0" *ngFor="let data of addTable.data; let i = index">
                  <tr [class.disabled-row]="!setOfCheckedAddCourses.has(data.courseId)"
                    [style.background-color]="isRegularCourseDisabled(data) ? '#fff1f0' : '#ffffff'"
                    [style.color]="isRegularCourseDisabled(data) ? '#595959' : ''">
                    <td class="paginate">
                      <ng-container *ngIf="isRegularCourseDisabled(data); else addCheckbox">
                        <span nz-icon nzType="lock" nzTheme="outline" style="color: #ff4d4f; font-size: 20px;"
                          nz-tooltip [nzTooltipTitle]="data.currentGrade === 'RA' ? 'Course is not available for add request' : 
                            (data.courseStatus === 'Taken' && (['A+', 'A', 'B', 'B+', 'C', 'D', ''].includes(data.currentGrade))) ? 
                            'Course has already been taken ' : 
                            'Course is not available for selection'" nzTooltipPlacement="right"
                          [nzTooltipColor]="'#1890ff'">
                        </span>
                      </ng-container>
                      <ng-template #addCheckbox>
                        <label nz-checkbox [nzChecked]="setOfCheckedAddCourses.has(data.courseId)"
                          (nzCheckedChange)="onItemChecked(data.courseId, $event, true)"
                          [nzDisabled]="isRegularCourseDisabled(data) || isCourseSelectedInOtherTable(data, 'add') || (selectedBatchCode && data.batchCode !== selectedBatchCode)">
                        </label>
                      </ng-template>
                    </td>
                    <!-- <td>{{data.batchCode}}</td> -->
                    <td>{{data.courseCode}}</td>
                    <td>{{ data.courseTitle }}</td>
                    <td>{{ data.courseStatus }}</td>
                    <td>{{ data.currentGrade }}</td>
                    <td style="text-align: center;">{{ data.creditHours }}</td>
                    <td style="text-align: center;">{{ data.totalAmount }}</td>
                    <td>
                      <nz-input-number *ngIf="setOfCheckedAddCourses.has(data.courseId)" [nzMin]="0" [nzMax]="3"
                        [nzStep]="1" [ngModel]="getCoursePriority(data.courseId)"
                        (ngModelChange)="updateCoursePriority(data.courseId, $event)"
                        [nzDisabled]="!setOfCheckedAddCourses.has(data.courseId)" style="width: 100px">
                      </nz-input-number>
                    </td>
                  </tr>
                </ng-container>
              </tbody>
              <tfoot class="footer-row">
                <tr>
                  <td colspan="5" style="font-weight: bold;">Total</td>
                  <td style="font-weight: bold;">{{ getTotalAddedCreditHours() }}</td>
                  <td style="font-weight: bold;">{{ getTotalAddedAmount() | number:'1.2-2' }}</td>
                  <td></td>
                </tr>
              </tfoot>
            </nz-table>
          </div>
        </nz-spin>
      </nz-card>
      <nz-card nzType="inner" [nzTitle]="courseAssessmentTitle" class="card-section">
        <nz-alert nzType="info" nzShowIcon [nzMessage]="'Course Assessment'"
          [nzDescription]="'Select courses that you need to retake or reassess. These courses will be marked for assessment purposes.'"
          style="margin-bottom: 16px;"></nz-alert>
        <nz-spin [nzSpinning]="isLoadingAssessmentCourses">
          <div class="responsive-table-wrapper">
            <nz-table #assessmentTable [nzData]="listOfCourseAssessment" nzShowSizeChanger
              (nzCurrentPageDataChange)="onCurrentPageDataChange($event)" nzBordered [nzShowPagination]="false">
              <thead class="table-header-row">
                <tr class="table-header-row">
                  <th class="paginate" [nzChecked]="checkedAssessmentCourses"
                    [nzIndeterminate]="indeterminateAssessmentCourses"
                    (nzCheckedChange)="onAllChecked($event, 'assessment')" [nzDisabled]="isAllCoursesDisabled()">
                  </th>
                  <th class="th-row">Course Code</th>
                  <th class="th-row">Course Title</th>
                  <th class="th-row">Previous Grade</th>
                  <th class="th-row">Current Grade</th>
                  <th class="th-row">Credit Hour</th>
                  <th class="th-row">Total Amount</th>
                </tr>
              </thead>
              <tbody>
                <ng-container tabindex="0" *ngFor="let data of assessmentTable.data; let i = index">
                  <tr [class.disabled-row]="!setOfCheckedAssessmentCourses.has(data.courseId)"
                    [style.background-color]="isCourseDisabled(data) ? '#fff1f0' : '#ffffff'"
                    [style.color]="isCourseDisabled(data) ? '#595959' : ''">
                    <td class="paginate">
                      <ng-container *ngIf="isCourseDisabled(data); else checkbox">
                        <span nz-icon nzType="lock" nzTheme="outline" style="color: #ff4d4f; font-size: 20px;"
                          nz-tooltip
                          [nzTooltipTitle]="data.currentGrade !== 'RA' ? 'The assessment result for this course has already changed' : 'The course cannot be added because it is not in the available course list or add request list.'"
                          nzTooltipPlacement="right" [nzTooltipColor]="'#1890ff'">
                        </span>
                      </ng-container>
                      <ng-template #checkbox>
                        <label nz-checkbox [nzChecked]="setOfCheckedAssessmentCourses.has(data.courseId)"
                          (nzCheckedChange)="onItemChecked(data.courseId, $event, false, true)">
                        </label>
                      </ng-template>
                    </td>
                    <td>{{data.courseCode}}</td>
                    <td>{{ data.courseTitle }}</td>
                    <td>{{ data.previousRAGrade }}</td>
                    <td>{{ data.currentGrade }}</td>
                    <td style="text-align: center;">{{ data.creditHours }}</td>
                    <td style="text-align: center;">{{ data.totalAmount }}</td>
                  </tr>
                </ng-container>
              </tbody>
              <tfoot class="footer-row">
                <tr>
                  <td colspan="5" style="font-weight: bold;">Total</td>
                  <td style="font-weight: bold; text-align: center;">{{ getTotalAssessmentCreditHours() }}</td>
                  <td style="font-weight: bold; text-align: center;">{{ getTotalAssessmentAmount() | number:'1.2-2' }}
                  </td>
                </tr>
              </tfoot>
            </nz-table>
          </div>
        </nz-spin>
      </nz-card>

      <nz-form-item>
        <nz-form-control [nzOffset]="12" [nzSpan]="12" class="send-request">
          <div *ngIf="totalSelectedCreditHours > getMaxAllowedCreditHours()" style="margin-bottom: 16px;">
            <nz-alert nzType="warning" nzShowIcon
              [nzMessage]="'Credit Hour Warning'"
              [nzDescription]="'You have selected ' + totalSelectedCreditHours + ' credit hours, which exceeds the recommended limit of ' + getMaxAllowedCreditHours() + ' credit hours. This may affect your academic performance.'">
            </nz-alert>
          </div>
          <button nz-button nzType="primary"
            [disabled]="(setOfCheckedId.size === 0 && setOfCheckedAddCourses.size === 0 && setOfCheckedAssessmentCourses.size === 0) || totalSelectedCreditHours > getMaxAllowedCreditHours()"
            [nzLoading]="isSubmitting" (click)="onSubmitClicked()">
            Submit
          </button>
          <div class="selection-summary">
            <span>Selected Courses:</span>
            <ul>
              <li>Semester : {{ setOfCheckedId.size }} </li>
              <li>Add Request : {{ setOfCheckedAddCourses.size }} </li>
              <li>Assessment : {{ setOfCheckedAssessmentCourses.size }} </li>
              <li>Total Credit Hours: {{ totalSelectedCreditHours }}</li>
            </ul>
          </div>
        </nz-form-control>
      </nz-form-item>

    </div>
    <ng-template #elseBlock>
      <img src="assets/images/r.jpg" alt="HiLCoE Logo" height="400" width="850">
      <!-- <nz-alert nzShowIcon nzType="info" nzMessage="info" [nzDescription]="descriptionTemplate1"></nz-alert> -->
      <!-- <ng-template #descriptionTemplate1> -->
        <!-- <h3>So far, there hasn't been any course offering prepared yet. </h3> -->
         <!-- <img src="assets/images/r.jpg" alt="HiLCoE Logo" height="400" width="850">  -->
      <!-- </ng-template> -->

    </ng-template>
  </nz-tab>

  <nz-tab [nzTitle]="seasonTitles" class="custom-tab no-sticky-tab" *ngIf="resultStatus==2 || resultStatus == 5">
    <div class="academic-header" *ngIf="studentTermCourseReg">
      <div class="academic-info">
        <div class="info-item">
          <span class="label">Student Name:</span>
          <span class="value">{{studentTermCourseReg?.fullName}}</span>
        </div>
        <div class="info-item">
          <span class="label">Student ID:</span>
          <span class="value">{{studentTermCourseReg?.studentId}}</span>
        </div>
        <div class="info-item">
          <span class="label">Batch Code:</span>
          <span class="value">{{studentTermCourseReg.batchCode}}</span>
        </div>

      </div>
    </div>
    <ng-template #titleoffering>
      <span nz-icon nzType="desktop"></span>
      {{ seasonTitles }}
    </ng-template>
    <div class="print-section">
      <button class="print-button" (click)="printSlip()">
        <span nz-icon nzType="printer" nzTheme="outline"></span>
        Show Slip
      </button>
      <button class="print-button" (click)="downloadPDF()">
        <span nz-icon nzType="download" nzTheme="outline"></span>
        Download PDF
      </button>
    </div>
    <div class="responsive-table-wrapper">
      <nz-table #basicTable [nzData]="studentTermCourseReg?.courseTermOfferings" nzShowSizeChanger
        (nzCurrentPageDataChange)="onCurrentPageDataChange($event)" nzBordered [nzShowPagination]="false">
        <thead class="table-header-row">
          <tr class="table-header-row">
            <th class="th-row">Course Code</th>
            <th class="th-row">Course Title</th>
            <th class="th-row">Credit Hour</th>
            <th class="th-row">Total Amount</th>
          </tr>
        </thead>
        <tbody>
          <ng-container tabindex="0" *ngFor="let data of basicTable.data; let i = index">
            <tr>
              <td>{{data.courseCode}}</td>
              <td>{{ data.courseTitle }}</td>
              <td style="text-align: center;">{{ data.creditHours }}</td>
              <td>{{ data.totalAmount }}</td>
            </tr>
          </ng-container>
        </tbody>
        <tfoot class="footer-row">
          <tr>
            <td colspan="2" style="font-weight: bold; text-align: left;">Total</td>
            <td style="font-weight: bold; text-align: center;"> {{studentTermCourseReg?.courseTermOfferings ? getTotalCreditHours():0 }}
            </td>
            <td style="font-weight: bold; text-align: center;"> {{studentTermCourseReg?.courseTermOfferings ? getTotalAmount():0 }}</td>
          </tr>
        </tfoot>
      </nz-table>
    </div>
  </nz-tab>
  <nz-tab nzTitle=" Payment Information" class="custom-tab" *ngIf="resultStatus==2 || resultStatus == 5">
    <div class="academic-header" *ngIf="studentTermCourseReg">
      <div class="academic-info">
        <div class="info-item">
          <span class="label">Student Name:</span>
          <span class="value">{{studentTermCourseReg?.fullName}}</span>
        </div>
        <div class="info-item">
          <span class="label">Student ID:</span>
          <span class="value">{{studentTermCourseReg?.studentId}}</span>
        </div>
        <div class="info-item">
          <span class="label">Batch Code:</span>
          <span class="value">{{studentTermCourseReg.batchCode}}</span>
        </div>

      </div>
    </div>
    <ng-template #titleoffering>
      <span nz-icon nzType="desktop"></span>
      Payment Information
    </ng-template>
    <div id="print-section">
      <div class="responsive-table-wrapper">
        <nz-table #basicTable [nzData]="studentTermCourseReg?.coursePayment" nzShowSizeChanger
          (nzCurrentPageDataChange)="onCurrentPageDataChange($event)" nzBordered [nzShowPagination]="false">
          <thead class="table-header-row">
            <tr class="table-header-row">
              <th class="th-row">Transaction Id</th>
              <th class="th-row">From Bank</th>
              <th class="th-row">To Bank</th>
              <th class="th-row">Transaction Date</th>
              <th class="th-row">Total Amount</th>
            </tr>
          </thead>
          <tbody>
            <ng-container tabindex="0" *ngFor="let data of basicTable.data; let i = index">
              <tr>
                <td>{{data.bankTransactionID}}</td>
                <td>{{ data.fromBank }}</td>
                <td>{{ getBankDescription(data.toBank) }}</td>
                <td>{{ data.transactionDate | date:'short' }}</td>
                <td>{{ data.amount }}</td>
              </tr>
            </ng-container>
          </tbody>
          <tfoot class="footer-row">
            <tr>
              <td colspan="4" style="font-weight: bold; text-align: left;">Total</td>
              <td style="font-weight: bold; text-align: center;"> {{studentTermCourseReg?.courseTermOfferings ? getTotalAmount():0 }}</td>
            </tr>
          </tfoot>
        </nz-table>
      </div>
    </div>
  </nz-tab>
</nz-tabset>