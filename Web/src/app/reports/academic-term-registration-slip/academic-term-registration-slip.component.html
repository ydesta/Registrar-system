<ng-template #customExpandIcon let-expand="expand" let-collapsed="collapsed">
  <span
    class="custom-expand-icon"
    [ngClass]="{ 'expanded': !collapsed }"
    (click)="expand($event)"
  >
    <i
      nz-icon
      [nzType]="collapsed ? 'plus-square' : 'minus-square'"
      [style.color]="collapsed ? '#1890ff' : '#ef4444'"
      style="font-size: 20px;"
    ></i>
  </span>
</ng-template>

<div class="content-container">
  <!-- Page Header -->
  <div class="header-section">
    <div class="page-title">
      <h1>Academic Term Registration Slip</h1>
      <p class="subtitle">Generate and view academic term registration slips for students</p>
    </div>
  </div>
  <!-- Collapsible Search Form -->
  <div class="search-section">
    <nz-collapse>
      <nz-collapse-panel [nzHeader]="searchHeader" [nzActive]="!isFormCollapsed"
        (nzActiveChange)="isFormCollapsed = !$event">

        <ng-template #searchHeader>
          <span>
            <i nz-icon nzType="search" nzTheme="outline"></i>
            Search Filters
          </span>
        </ng-template>

        <form nz-form [formGroup]="formCourseOffered">
          <div nz-row [nzGutter]="24">
            <!-- Academic Term -->
            <div nz-col [nzSpan]="12">
              <nz-form-item>
                <nz-form-label [nzSpan]="8">Academic Term</nz-form-label>
                <nz-form-control [nzSpan]="16">
                  <nz-select formControlName="termId" nzPlaceHolder="Select Academic Term" nzShowSearch nzAllowClear style="width: 100%;">
                    <nz-option *ngFor="let item of listOfTermNumber" [nzValue]="item.Id" [nzLabel]="item.Description"></nz-option>
                  </nz-select>
                </nz-form-control>
              </nz-form-item>
            </div>

            <!-- Term Year -->
            <div nz-col [nzSpan]="12">
              <nz-form-item>
                <nz-form-label [nzSpan]="8">Term Year</nz-form-label>
                <nz-form-control [nzSpan]="16">
                  <nz-select formControlName="termYear" nzPlaceHolder="Select Term Year" nzShowSearch nzAllowClear style="width: 100%;">
                    <nz-option *ngFor="let item of yearList" [nzValue]="item" [nzLabel]="item"></nz-option>
                  </nz-select>
                </nz-form-control>
              </nz-form-item>
            </div>

            <!-- Batch Code -->
            <div nz-col [nzSpan]="12">
              <nz-form-item>
                <nz-form-label [nzSpan]="8">Batch Code</nz-form-label>
                <nz-form-control [nzSpan]="16">
                  <nz-select formControlName="batchCode" nzPlaceHolder="Select Batch Code" nzShowSearch nzAllowClear style="width: 100%;">
                    <nz-option *ngFor="let item of listOfBatch" [nzValue]="item.id" [nzLabel]="item.batchCode"></nz-option>
                  </nz-select>
                </nz-form-control>
              </nz-form-item>
            </div>

            <!-- Start Date -->
            <div nz-col [nzSpan]="12">
              <nz-form-item>
                <nz-form-label [nzSpan]="8">Start Date</nz-form-label>
                <nz-form-control [nzSpan]="16">
                  <nz-date-picker formControlName="startDate" nzPlaceHolder="Select Start Date" nzAllowClear style="width: 100%;"></nz-date-picker>
                </nz-form-control>
              </nz-form-item>
            </div>

            <!-- End Date -->
            <div nz-col [nzSpan]="12">
              <nz-form-item>
                <nz-form-label [nzSpan]="8">End Date</nz-form-label>
                <nz-form-control [nzSpan]="16">
                  <nz-date-picker formControlName="endDate" nzPlaceHolder="Select End Date" nzAllowClear style="width: 100%;"></nz-date-picker>
                </nz-form-control>
              </nz-form-item>
            </div>
          </div>

          <!-- Action Buttons -->
          <div nz-row>
            <div nz-col [nzSpan]="24" class="form-actions">
              <button nz-button nzType="default" (click)="resetData()" class="mr-2">
                <i nz-icon nzType="reload" nzTheme="outline"></i>
                Reset
              </button>
              <button nz-button nzType="primary" (click)="generatePdf()" [nzLoading]="tbLoading">
                <i nz-icon nzType="file-pdf" nzTheme="outline"></i>
                Generate Slip
              </button>
            </div>
          </div>
        </form>
      </nz-collapse-panel>
    </nz-collapse>
  </div>

  <!-- Data Table -->
  <div class="table-container" *ngIf="hasSearched">
    <!-- Table Header -->
    <div class="table-header" *ngIf="totalRecord > 0">
      <h3>Registration Slips</h3>
      <div class="table-actions">
        <button nz-button nzType="default" (click)="toggleFormCollapse()" class="mr-2">
          <i nz-icon nzType="search" nzTheme="outline"></i>
          Modify Search
        </button>
        <!-- <button nz-button nzType="primary" (click)="printRegistrationSlip()" class="mr-2">
          <i nz-icon nzType="printer" nzTheme="outline"></i>
          Print
        </button>
        <button nz-button nzType="primary" (click)="downloadRegistrationSlip()">
          <i nz-icon nzType="download" nzTheme="outline"></i>
          Download
        </button> -->
      </div>
    </div>

    <!-- Results Table -->
    <div id="print-section" *ngIf="totalRecord > 0">
      <nz-table #basicTable [nzData]="listOdRegisteredStudent" nzBordered [nzPageSize]="pageSize" [nzShowSizeChanger]="true"
        [nzTotal]="totalRecord" [nzPageIndex]="pageindex" (nzPageIndexChange)="onPageIndexChange($event)"
        (nzPageSizeChange)="onPageSizeChange($event)" [nzLoading]="tbLoading" [nzNoResult]="emptyTpl"
        [nzShowQuickJumper]="true" [nzShowTotal]="totalTemplate" [nzPageSizeOptions]="pageSizeOption"
        [nzScroll]="{ x: '1200px' }" style="overflow-x: auto;" class="mobile-table-container">
    <thead>
      <tr>
        <th class="expand-column">#</th>
        <th nzSortOrder="null" (nzSortOrderChange)="sort('studentCode', $event)" style="min-width: 120px;">Student Code</th>
        <th nzSortOrder="null" (nzSortOrderChange)="sort('fullName', $event)" style="min-width: 150px;">Full Name</th>
        <th nzSortOrder="null" (nzSortOrderChange)="sort('registrationDate', $event)" style="min-width: 120px;">Registration Date</th>
        <th nzSortOrder="null" (nzSortOrderChange)="sort('fromBank', $event)" style="min-width: 100px;">From Bank</th>
        <th nzSortOrder="null" (nzSortOrderChange)="sort('toBank', $event)" style="min-width: 100px;">To Bank</th>
        <th nzSortOrder="null" (nzSortOrderChange)="sort('bankTransactionId', $event)" style="min-width: 120px;">Transaction Id</th>
        <th class="th-row paginate sticky-action" style="min-width: 80px;">Action</th>
      </tr>
    </thead>
    <tbody>
      <ng-container tabindex="0" *ngFor="let data of basicTable.data; let i = index">
        <tr>
          <td class="expand-column">
            <span
              class="custom-expand-icon"
              [ngClass]="{ 'expanded': expandSet.has(data.studentCode) }"
              (click)="onExpandChange(data.studentCode, !expandSet.has(data.studentCode))"
            >
              <i
                nz-icon
                [nzType]="expandSet.has(data.studentCode) ? 'minus-square' : 'plus-square'"
                [style.color]="expandSet.has(data.studentCode) ? '#ef4444' : '#1890ff'"
              ></i>
            </span>
          </td>
          <td>{{ data.studentCode }}</td>
          <td>{{data.fullName}}</td>
          <td>{{ data.registrationDate && data.registrationDate !== '-' ? (data.registrationDate | date : "dd-MM-yyyy") : '-' }}</td>
          <td>{{ data.fromBank }}</td>
          <td>{{ data.toBank }}</td>
          <td>{{ data.bankTransactionId }}</td>
          <td class="paginate sticky-action" [class.sticky-action-even]="i % 2 === 1">
            <ng-container>
              <button nz-button nz-dropdown [nzDropdownMenu]="menu" nzPlacement="bottomLeft">
                <i class="more" nz-icon nzType="more" nzTheme="outline"></i>
              </button>
              <nz-dropdown-menu #menu="nzDropdownMenu">
                <ul nz-menu style="padding-right: 50px">
                  <li *ngIf="data.fileName">
                    <a style="border-style: none" (click)="getFileName(data.fileName)">
                      <i nz-icon nzType="edit" nzTheme="fill"></i>
                      <span>View File</span>
                    </a>
                  </li>
                </ul>
              </nz-dropdown-menu>
            </ng-container>
          </td>
        </tr>

        <tr [nzExpand]="expandSet.has(data.studentCode)">
          <td colspan="8">
            <nz-table [nzData]="getCourseDetails(data)" nzBordered [nzScroll]="{ x: '600px' }" [nzShowPagination]="false">
              <thead>
                <tr>
                  <th style="min-width: 80px;">Serial No.</th>
                  <th style="min-width: 120px;">Course Code</th>
                  <th style="min-width: 200px;">Course Title</th>
                  <th style="min-width: 100px;">Credit Hours</th>
                  <th style="min-width: 100px;">TotalAmount</th>
                </tr>
              </thead>
    <tbody>
      <tr *ngFor="let course of getCourseDetails(data); let i = index">
        <td>{{ i + 1 }}</td>
        <td>{{ course.code }}</td>
        <td>{{ course.title }}</td>
        <td>{{ course.creditHours }}</td>
        <td>{{ course.amount }}</td>

      </tr>
    </tbody>
    <tfoot class="footer-row">
      <tr>
        <td></td>
        <td></td>
        <td>Total </td>
        <td>{{ getTotalCreditHours(data) }}</td>
        <td>{{getTotalAmount(data)}}</td>
        <td></td>
      </tr>
    </tfoot>
  </nz-table>
  </td>
  </tr>
  </ng-container>

  </tbody>
        <ng-template #emptyTpl>
          <div class="no-data">
            <span nz-icon nzType="book" nzTheme="outline"></span>
            <p>No registration slips available</p>
          </div>
        </ng-template>
      </nz-table>
    </div>

    <!-- No Results State -->
    <div class="no-results-container" *ngIf="totalRecord === 0 && !tbLoading">
      <div class="no-results-content">
        <div class="no-results-icon">
          <span nz-icon nzType="search" nzTheme="outline"></span>
        </div>
        <h3 class="no-results-title">No Results Found</h3>
        <p class="no-results-description">
          No registration slips found for the selected criteria. Try adjusting your search filters.
        </p>
        <div class="no-results-actions">
          <button nz-button nzType="default" (click)="resetData()" class="mr-2">
            <i nz-icon nzType="reload" nzTheme="outline"></i>
            Clear Filters
          </button>
          <button nz-button nzType="primary" (click)="isFormCollapsed = false">
            <i nz-icon nzType="search" nzTheme="outline"></i>
            Modify Search
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Template for showing total records -->
  <ng-template #totalTemplate let-total let-range="range">
    Showing {{ range[0] }}-{{ range[1] }} of {{ total }} items
  </ng-template>
</div>